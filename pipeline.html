<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline ‚Äî Troy's Command Center</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .header {
            background: rgba(0,0,0,0.3);
            padding: 18px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header h1 { font-size: 1.6rem; color: #00d4ff; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .header a { color: #888; text-decoration: none; font-size: 0.9rem; }
        .header a:hover { color: #00d4ff; }
        .source-badge {
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 20px;
            background: rgba(0,200,83,0.15);
            color: #00c853;
            border: 1px solid rgba(0,200,83,0.3);
        }
        .source-badge.snapshot {
            background: rgba(255,193,7,0.15);
            color: #ffc107;
            border-color: rgba(255,193,7,0.3);
        }
        .container { max-width: 1300px; margin: 0 auto; padding: 28px 20px; }

        .summary-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
        }
        .summary-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px 22px;
            border-left: 4px solid #00d4ff;
            transition: transform 0.2s;
        }
        .summary-card:hover { transform: translateY(-2px); }
        .summary-card.hot        { border-left-color: #ff6b35; }
        .summary-card.goal-card  { border-left-color: #00c853; }
        .summary-card.collected  { border-left-color: #a855f7; }
        .sc-label { color: #888; font-size: 0.82rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .sc-value { font-size: 1.9rem; font-weight: 700; color: #fff; margin: 6px 0 4px; }
        .sc-sub   { font-size: 0.82rem; color: #666; }
        .sc-sub.green  { color: #00c853; }
        .sc-sub.orange { color: #ff9800; }
        .sc-sub.red    { color: #ff1744; }

        .monthly-section { margin-bottom: 28px; }
        .section-title {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 14px;
        }
        .monthly-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 6px;
        }
        @media (max-width: 900px) { .monthly-grid { grid-template-columns: repeat(6, 1fr); } }
        .month-bar {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 10px 6px 8px;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 72px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        .month-bar.current { border: 1px solid rgba(0,212,255,0.4); }
        .month-fill {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(0,212,255,0.22), transparent);
            border-radius: 0 0 8px 8px;
        }
        .month-fill.current { background: linear-gradient(to top, rgba(0,212,255,0.45), transparent); }
        .month-name  { font-size: 0.7rem; color: #888; position: relative; z-index: 1; }
        .month-value { font-size: 0.78rem; font-weight: 600; color: #fff; position: relative; z-index: 1; margin-top: 2px; }

        .pipeline-section { margin-bottom: 28px; }
        .pipeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .pipeline-header h2 { font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .count-badge {
            background: rgba(0,212,255,0.15);
            color: #00d4ff;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .count-badge.hot   { background: rgba(255,107,53,0.2); color: #ff6b35; }
        .count-badge.green { background: rgba(0,200,83,0.15); color: #00c853; }

        table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
        thead th {
            text-align: left;
            padding: 10px 12px;
            background: rgba(255,255,255,0.06);
            color: #888;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        thead th:first-child { border-radius: 8px 0 0 8px; }
        thead th:last-child  { border-radius: 0 8px 8px 0; }
        tbody tr { border-bottom: 1px solid rgba(255,255,255,0.04); transition: background 0.15s; }
        tbody tr:hover { background: rgba(255,255,255,0.04); }
        td { padding: 10px 12px; vertical-align: middle; }
        .td-name  { font-weight: 600; max-width: 200px; }
        .td-notes { color: #666; font-size: 0.8rem; max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .td-next  { color: #aaa; font-size: 0.8rem; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .td-money { text-align: right; font-weight: 600; color: #00d4ff; white-space: nowrap; }
        .td-money.dim   { color: #888; }
        .td-money.green { color: #00c853; }
        .pct-pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.78rem;
            font-weight: 600;
        }
        .pct-100 { background: rgba(0,200,83,0.2);   color: #00c853; }
        .pct-75  { background: rgba(0,212,255,0.15);  color: #00d4ff; }
        .pct-50  { background: rgba(255,193,7,0.15);  color: #ffc107; }
        .pct-25  { background: rgba(255,152,0,0.15);  color: #ff9800; }
        .pct-0   { background: rgba(255,255,255,0.06);color: #666; }
        .pct-tbd { background: rgba(255,255,255,0.04);color: #555; }

        .loading { text-align: center; padding: 60px; color: #888; }
        .loading span { animation: pulse 1.5s infinite; display: inline-block; }
        @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.4} }
    </style>
</head>
<body>

<div class="header">
    <h1>üí∞ Pipeline ‚Äî Troy Treleaven</h1>
    <div class="header-right">
        <span id="sourceBadge" class="source-badge snapshot">‚è≥ Loading‚Ä¶</span>
        <a href="index.html">‚Üê Dashboard</a>
    </div>
</div>

<div class="container">
    <div id="app"><div class="loading"><span>‚è≥ Loading pipeline data‚Ä¶</span></div></div>
</div>

<script src="pipeline-loader.js"></script>
<script>
const fmt = n => {
    if (n >= 1000000) return '$' + (n/1000000).toFixed(1) + 'M';
    if (n >= 1000)    return '$' + (n/1000).toFixed(n % 1000 === 0 ? 0 : 1) + 'K';
    return '$' + n.toLocaleString();
};
const fmtFull = n => '$' + Math.round(n).toLocaleString();

function pctPill(p) {
    if (p === null || p === undefined) return '<span class="pct-pill pct-tbd">TBD</span>';
    const cls = p >= 100 ? 'pct-100' : p >= 75 ? 'pct-75' : p >= 50 ? 'pct-50' : p >= 25 ? 'pct-25' : 'pct-0';
    return `<span class="pct-pill ${cls}">${p}%</span>`;
}

function dealRow(d) {
    return `<tr>
        <td class="td-name" title="${d.name}">${d.name}</td>
        <td class="td-notes" title="${d.notes}">${d.notes || '‚Äî'}</td>
        <td>${pctPill(d.probability)}</td>
        <td class="td-money">${fmtFull(d.projectedSale)}</td>
        <td class="td-money dim">${d.netForecast > 0 ? fmtFull(d.netForecast) : '‚Äî'}</td>
        <td class="td-next" title="${d.nextStep}">${d.nextStep || '‚Äî'}</td>
    </tr>`;
}

function tableWrap(rows) {
    return `<table>
        <thead><tr>
            <th>Opportunity</th><th>Notes</th><th>Probability</th>
            <th style="text-align:right">Value</th>
            <th style="text-align:right">Wtd Forecast</th>
            <th>Next Step</th>
        </tr></thead>
        <tbody>${rows.join('')}</tbody>
    </table>`;
}

function renderMonthly(mf) {
    const MONTHS = ['Sep','Oct','Nov','Dec','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug'];
    const max = Math.max(...MONTHS.map(m => mf[m] || 0), 1);
    return MONTHS.map(m => {
        const v = mf[m] || 0;
        const h = Math.max(4, Math.round((v / max) * 52));
        const cur = m === 'Feb';
        return `<div class="month-bar${cur?' current':''}">
            <div class="month-fill${cur?' current':''}" style="height:${h}px"></div>
            <div class="month-name">${m}</div>
            <div class="month-value">${v > 0 ? fmt(v) : '‚Äì'}</div>
        </div>`;
    }).join('');
}

window.onPipelineLoaded(function(data) {
    const t = data.totals;
    const pctGoal   = Math.round(t.collectedYTD / t.budgetGoal * 100);
    const shortfall = t.budgetGoal - t.collectedYTD;
    const subClass  = pctGoal >= 100 ? 'green' : pctGoal >= 50 ? 'orange' : 'red';

    const badge = document.getElementById('sourceBadge');
    if (data.source === 'live') {
        badge.textContent = 'üü¢ Live ‚Äî Google Sheets';
        badge.className = 'source-badge';
    } else {
        badge.textContent = 'üì∏ Snapshot ¬∑ ' + data.lastUpdated;
        badge.className = 'source-badge snapshot';
    }

    document.getElementById('app').innerHTML = `
        <div class="summary-bar">
            <div class="summary-card">
                <div class="sc-label">Total Pipeline</div>
                <div class="sc-value">${fmt(t.totalPipeline)}</div>
                <div class="sc-sub">${data.warmPipeline.length + data.hotOpps.length} active opportunities</div>
            </div>
            <div class="summary-card">
                <div class="sc-label">Weighted Forecast</div>
                <div class="sc-value">${fmt(t.weightedForecast)}</div>
                <div class="sc-sub">Probability-adjusted</div>
            </div>
            <div class="summary-card collected">
                <div class="sc-label">Collected YTD</div>
                <div class="sc-value">${fmt(t.collectedYTD)}</div>
                <div class="sc-sub ${subClass}">${pctGoal}% of $600K goal</div>
            </div>
            <div class="summary-card hot">
                <div class="sc-label">Hot Opps</div>
                <div class="sc-value">${t.hotCount}</div>
                <div class="sc-sub">‚â•75% probability</div>
            </div>
            <div class="summary-card goal-card">
                <div class="sc-label">Feb Collection</div>
                <div class="sc-value">${fmt(t.thisMonth)}</div>
                <div class="sc-sub ${shortfall > 0 ? 'red' : 'green'}">${shortfall > 0 ? fmtFull(shortfall) + ' to $600K goal' : 'üéâ Annual goal hit!'}</div>
            </div>
        </div>

        <div class="monthly-section">
            <div class="section-title">üìÖ Monthly Cash Flow Forecast (all sections)</div>
            <div class="monthly-grid">${renderMonthly(data.monthlyForecast)}</div>
        </div>

        <div class="pipeline-section">
            <div class="pipeline-header">
                <h2>üî• Hot Opportunities <span class="count-badge hot">${data.hotOpps.length}</span></h2>
            </div>
            ${tableWrap(data.hotOpps.map(dealRow))}
        </div>

        <div class="pipeline-section">
            <div class="pipeline-header">
                <h2>üåä Warm Pipeline <span class="count-badge">${data.warmPipeline.length}</span></h2>
            </div>
            ${tableWrap(data.warmPipeline.map(dealRow))}
        </div>

        <div class="pipeline-section">
            <div class="pipeline-header">
                <h2>‚úÖ Collected / Closed <span class="count-badge green">${data.collected.length}</span></h2>
            </div>
            ${tableWrap(data.collected.map(dealRow))}
        </div>`;
});
</script>
</body>
</html>
